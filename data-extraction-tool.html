<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Data Extraction Tool - Gaza Crisis Documentation</title>
    <meta name="description" content="Advanced extraction including images and media from URLs">
    <link rel="stylesheet" href="shared-styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        .extraction-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .extraction-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .method-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .method-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .method-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .method-card.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .method-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .method-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        .method-description {
            color: #666;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .method-pros {
            background: #d4edda;
            color: #155724;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .extraction-workspace {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .url-input-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .url-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .proxy-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .proxy-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }

        .proxy-item.testing {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .proxy-item.success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .proxy-item.failed {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .extraction-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }

        .extraction-results {
            margin-top: 2rem;
        }

        .results-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .results-tab {
            padding: 0.75rem 1.5rem;
            background: #f8f9fa;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .results-tab.active {
            background: #3498db;
            color: white;
        }

        .results-content {
            display: none;
            background: #f8f9fa;
            border-radius: 0 6px 6px 6px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .results-content.active {
            display: block;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .image-item:hover {
            transform: translateY(-5px);
        }

        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-info {
            padding: 1rem;
        }

        .image-info h5 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .image-info p {
            margin: 0;
            font-size: 0.8rem;
            color: #666;
        }

        .download-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .extraction-log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .browser-extension-info {
            background: #e3f2fd;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #3498db;
        }

        .api-service-info {
            background: #fff3e0;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #ff9800;
        }

        @media (max-width: 768px) {
            .method-selector {
                grid-template-columns: 1fr;
            }

            .extraction-controls {
                flex-direction: column;
            }

            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1 class="logo">
                <a href="index.html">Gaza Crisis Documentation - Advanced Extraction Tool</a>
            </h1>
            <nav class="nav">
                <a href="index.html" class="nav-btn">‚Üê Back to Main</a>
                <a href="admin-panel.html" class="nav-btn">üìã Admin Panel</a>
            </nav>
            <button class="theme-toggle" aria-label="Toggle theme">üåô</button>
        </div>
    </header>

    <main class="main">
        <div class="extraction-container">
            <!-- Header -->
            <div class="extraction-header">
                <h2>üîç Advanced Data Extraction Tool</h2>
                <p>Extract text, images, and media from URLs with multiple bypass methods</p>
                <p><strong>Current User:</strong> aliattia02 | <strong>Date:</strong> 2025-08-13 11:20:03</p>
            </div>

            <!-- Method Selection -->
            <div class="method-selector">
                <div class="method-card" data-method="proxy" onclick="selectMethod('proxy')">
                    <span class="method-icon">üåê</span>
                    <div class="method-title">Smart Proxy Chain</div>
                    <div class="method-description">Uses multiple proxy services with automatic fallback</div>
                    <div class="method-pros">‚úÖ Works with most sites ‚Ä¢ ‚úÖ Extracts images ‚Ä¢ ‚ö†Ô∏è May be blocked</div>
                </div>

                <div class="method-card" data-method="extension" onclick="selectMethod('extension')">
                    <span class="method-icon">üîå</span>
                    <div class="method-title">Browser Extension</div>
                    <div class="method-description">Install a CORS-bypassing browser extension</div>
                    <div class="method-pros">‚úÖ Reliable ‚Ä¢ ‚úÖ Full access ‚Ä¢ ‚ö†Ô∏è Requires installation</div>
                </div>

                <div class="method-card" data-method="api" onclick="selectMethod('api')">
                    <span class="method-icon">ü§ñ</span>
                    <div class="method-title">External API Service</div>
                    <div class="method-description">Use ScrapingBee, Puppeteer, or similar services</div>
                    <div class="method-pros">‚úÖ Professional ‚Ä¢ ‚úÖ Images + JS ‚Ä¢ üí∞ Paid service</div>
                </div>

                <div class="method-card selected" data-method="hybrid" onclick="selectMethod('hybrid')">
                    <span class="method-icon">‚ö°</span>
                    <div class="method-title">Hybrid Approach</div>
                    <div class="method-description">Try all methods automatically + manual backup</div>
                    <div class="method-pros">‚úÖ Best success rate ‚Ä¢ ‚úÖ All content types ‚Ä¢ ‚úÖ Free</div>
                </div>
            </div>

            <!-- Browser Extension Info -->
            <div id="extension-info" class="browser-extension-info" style="display: none;">
                <h4>üîå Browser Extension Method</h4>
                <p><strong>Recommended Extensions:</strong></p>
                <ul>
                    <li><strong>CORS Unblock</strong> - Chrome Web Store</li>
                    <li><strong>Disable CORS</strong> - Firefox Add-ons</li>
                    <li><strong>Access-Control-Allow-Origin</strong> - Chrome/Edge</li>
                </ul>
                <p><strong>How to use:</strong> Install extension ‚Üí Enable ‚Üí Reload this page ‚Üí Try extraction</p>
            </div>

            <!-- API Service Info -->
            <div id="api-info" class="api-service-info" style="display: none;">
                <h4>ü§ñ External API Services</h4>
                <p><strong>Recommended Services:</strong></p>
                <ul>
                    <li><strong>ScrapingBee</strong> - $29/month, 100k requests</li>
                    <li><strong>ScrapFly</strong> - $10/month, 10k requests</li>
                    <li><strong>WebScraping.AI</strong> - $19/month, 50k requests</li>
                </ul>
                <input type="text" id="apiKey" placeholder="Enter your API key here..." style="width: 100%; padding: 0.5rem; margin: 1rem 0;">
                <p><em>Enter your API key above to use professional scraping services</em></p>
            </div>

            <!-- Extraction Workspace -->
            <div class="extraction-workspace">
                <h3>üéØ Extract from URL</h3>

                <div class="url-input-section">
                    <label for="targetUrl"><strong>Target URL:</strong></label>
                    <input type="url" id="targetUrl" class="url-input"
                           placeholder="https://www.aljazeera.com/news/longform/2025/3/26/gazas-stolen-childhood..."
                           value="https://www.aljazeera.com/news/longform/2025/3/26/gazas-stolen-childhood-the-thousands-of-children-israel-killed">

                    <div class="extraction-controls">
                        <button class="btn btn-primary" onclick="startExtraction()">üîç Start Extraction</button>
                        <button class="btn btn-warning" onclick="testAllProxies()">üß™ Test All Methods</button>
                        <button class="btn btn-success" onclick="generateAllCSVs()">üìÑ Export All Data</button>
                        <button class="btn btn-danger" onclick="clearAllResults()">üóëÔ∏è Clear Results</button>
                    </div>
                </div>

                <!-- Proxy Status -->
                <div class="proxy-status" id="proxyStatus"></div>

                <!-- Results Section -->
                <div class="extraction-results">
                    <div class="results-tabs">
                        <button class="results-tab active" data-tab="images" onclick="switchResultsTab('images')">üì∏ Images</button>
                        <button class="results-tab" data-tab="cases" onclick="switchResultsTab('cases')">üë• Individual Cases</button>
                        <button class="results-tab" data-tab="text" onclick="switchResultsTab('text')">üìù Text Content</button>
                        <button class="results-tab" data-tab="metadata" onclick="switchResultsTab('metadata')">üìä Metadata</button>
                    </div>

                    <div id="images-content" class="results-content active">
                        <h4>Extracted Images</h4>
                        <div id="imageGallery" class="image-gallery">
                            <p>No images extracted yet. Click "Start Extraction" to begin.</p>
                        </div>
                    </div>

                    <div id="cases-content" class="results-content">
                        <h4>Individual Cases Data</h4>
                        <div id="casesData"></div>
                    </div>

                    <div id="text-content" class="results-content">
                        <h4>Extracted Text Content</h4>
                        <div id="textContent"></div>
                    </div>

                    <div id="metadata-content" class="results-content">
                        <h4>Page Metadata</h4>
                        <div id="metadataContent"></div>
                    </div>
                </div>

                <div class="extraction-log" id="extractionLog"></div>
            </div>
        </div>
    </main>

    <script>
        // Advanced Data Extraction Tool JavaScript
        console.log('üîç Advanced Data Extraction Tool Initializing...');
        console.log('User: aliattia02 | Date: 2025-08-13 11:20:03');

        // Global variables
        let selectedMethod = 'hybrid';
        let extractedData = {
            images: [],
            cases: [],
            text: '',
            metadata: {}
        };

        let currentUser = 'aliattia02';
        let currentDateTime = '2025-08-13 11:20:03';

        // Enhanced proxy services with specific capabilities
        const advancedProxyServices = [
            {
                name: 'AllOrigins',
                url: (targetUrl) => `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`,
                parseResponse: (data) => data.contents,
                supportsImages: true,
                reliability: 0.7
            },
            {
                name: 'ThingProxy',
                url: (targetUrl) => `https://thingproxy.freeboard.io/fetch/${targetUrl}`,
                parseResponse: (data) => data,
                supportsImages: true,
                reliability: 0.6
            },
            {
                name: 'CORS Anywhere (Public)',
                url: (targetUrl) => `https://cors-anywhere.herokuapp.com/${targetUrl}`,
                parseResponse: (data) => data,
                supportsImages: true,
                reliability: 0.4
            },
            {
                name: 'Proxy API',
                url: (targetUrl) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`,
                parseResponse: (data) => data,
                supportsImages: false,
                reliability: 0.5
            },
            {
                name: 'JSONProxy',
                url: (targetUrl) => `https://jsonp.afeld.me/?url=${encodeURIComponent(targetUrl)}`,
                parseResponse: (data) => data,
                supportsImages: false,
                reliability: 0.3
            }
        ];

        // External API services configuration
        const apiServices = {
            scrapingbee: {
                name: 'ScrapingBee',
                url: (targetUrl, apiKey) => `https://app.scrapingbee.com/api/v1/?api_key=${apiKey}&url=${encodeURIComponent(targetUrl)}&render_js=true`,
                supportsImages: true,
                parseResponse: (data) => data
            },
            scrapfly: {
                name: 'ScrapFly',
                url: (targetUrl, apiKey) => `https://api.scrapfly.io/scrape?key=${apiKey}&url=${encodeURIComponent(targetUrl)}&render_js=true`,
                supportsImages: true,
                parseResponse: (data) => data.result.content
            }
        };

        // Initialize the tool
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            updateProxyStatus();
            logMessage('üöÄ Advanced extraction tool ready');
        });

        function selectMethod(method) {
            selectedMethod = method;

            // Update UI
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.method === method);
            });

            // Show/hide method-specific info
            document.getElementById('extension-info').style.display = method === 'extension' ? 'block' : 'none';
            document.getElementById('api-info').style.display = method === 'api' ? 'block' : 'none';

            logMessage(`üìã Selected method: ${method}`);
        }

        async function startExtraction() {
            const url = document.getElementById('targetUrl').value;
            if (!url) {
                alert('Please enter a URL to extract from');
                return;
            }

            logMessage(`üéØ Starting extraction from: ${url}`);
            logMessage(`üìã Using method: ${selectedMethod}`);

            clearAllResults();

            try {
                switch (selectedMethod) {
                    case 'proxy':
                        await extractUsingProxies(url);
                        break;
                    case 'extension':
                        await extractUsingExtension(url);
                        break;
                    case 'api':
                        await extractUsingAPI(url);
                        break;
                    case 'hybrid':
                        await extractUsingHybridMethod(url);
                        break;
                }
            } catch (error) {
                logMessage(`‚ùå Extraction failed: ${error.message}`);
            }
        }

        async function extractUsingHybridMethod(url) {
            logMessage('‚ö° Starting hybrid extraction...');

            // Step 1: Try all proxy services
            let htmlContent = null;
            for (const proxy of advancedProxyServices) {
                try {
                    logMessage(`üåê Trying ${proxy.name}...`);
                    updateProxyStatus(proxy.name, 'testing');

                    const response = await fetch(proxy.url(url), {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });

                    if (response.ok) {
                        const data = await response.text();
                        htmlContent = typeof data === 'string' ? data : proxy.parseResponse(JSON.parse(data));

                        if (htmlContent && htmlContent.length > 1000) {
                            updateProxyStatus(proxy.name, 'success');
                            logMessage(`‚úÖ Successfully fetched via ${proxy.name}`);
                            break;
                        }
                    }
                    updateProxyStatus(proxy.name, 'failed');
                } catch (error) {
                    updateProxyStatus(proxy.name, 'failed');
                    logMessage(`‚ùå ${proxy.name} failed: ${error.message}`);
                }
            }

            if (htmlContent) {
                // Step 2: Extract all content types
                await extractImagesFromHTML(htmlContent, url);
                await extractCasesFromHTML(htmlContent, url);
                await extractTextFromHTML(htmlContent);
                await extractMetadataFromHTML(htmlContent, url);

                logMessage('‚úÖ Hybrid extraction completed successfully');
            } else {
                logMessage('‚ùå All proxy methods failed, showing manual instructions');
                showManualFallback(url);
            }
        }

        async function extractImagesFromHTML(html, baseUrl) {
            logMessage('üì∏ Extracting images...');

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const images = [];
            const imgElements = doc.querySelectorAll('img');

            imgElements.forEach((img, index) => {
                const src = img.getAttribute('src');
                const alt = img.getAttribute('alt') || '';
                const caption = img.getAttribute('title') || alt;

                if (src && !src.startsWith('data:') && src.length > 10) {
                    let fullUrl = src;

                    // Convert relative URLs to absolute
                    if (src.startsWith('//')) {
                        fullUrl = 'https:' + src;
                    } else if (src.startsWith('/')) {
                        const baseUrlObj = new URL(baseUrl);
                        fullUrl = baseUrlObj.origin + src;
                    } else if (!src.startsWith('http')) {
                        const baseUrlObj = new URL(baseUrl);
                        fullUrl = baseUrlObj.origin + '/' + src;
                    }

                    // Determine if it's likely a relevant image
                    const relevance = determineImageRelevance(alt, caption, src);

                    if (relevance > 0.3) { // Only include relevant images
                        images.push({
                            src: fullUrl,
                            alt: alt,
                            caption: caption,
                            link: baseUrl,
                            last_updated: currentDateTime.split(' ')[0],
                            data_source: 'Extracted from ' + new URL(baseUrl).hostname,
                            verification_status: 'Extracted',
                            relevance_score: relevance.toFixed(2),
                            index: index
                        });
                    }
                }
            });

            extractedData.images = images;
            displayImages(images);
            logMessage(`üì∏ Found ${images.length} relevant images`);
        }

        function determineImageRelevance(alt, caption, src) {
            const text = (alt + ' ' + caption + ' ' + src).toLowerCase();
            const relevantKeywords = [
                'gaza', 'palestine', 'child', 'children', 'victim', 'casualty',
                'hospital', 'school', 'family', 'killed', 'injured', 'destroyed',
                'refugee', 'displaced', 'humanitarian', 'crisis', 'war', 'conflict'
            ];

            let score = 0;
            relevantKeywords.forEach(keyword => {
                if (text.includes(keyword)) score += 0.2;
            });

            // Boost score for larger images
            if (src.includes('1200') || src.includes('1920') || src.includes('large')) score += 0.3;

            // Reduce score for UI elements
            if (text.includes('logo') || text.includes('icon') || text.includes('button') || text.includes('arrow')) {
                score -= 0.5;
            }

            return Math.max(0, Math.min(1, score));
        }

        async function extractCasesFromHTML(html, url) {
            logMessage('üë• Extracting individual cases...');

            // Use the enhanced parsing logic from the previous version
            const cases = [];

            // Enhanced patterns for Al Jazeera and similar news sites
            const patterns = {
                names: [
                    /([A-Z][a-z]+(?: [A-Z][a-z]+)*),?\s*(?:aged?|age)\s*(\d+)/gi,
                    /(\w+(?:\s+\w+)*),?\s*(\d+)(?:\s*years?\s*old)?/gi,
                    /(\w+(?:\s+\w+)+)\s*-\s*(\d+)/gi,
                    /(\w+(?:\s+\w+)*)\s*\((\d+)\)/gi
                ]
            };

            // Process the HTML content
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Extract text content from article body
            const articleSelectors = [
                '.article-content', '.story-body', '.entry-content', '.post-content',
                'article', '.content', 'main', '[role="main"]'
            ];

            let articleText = '';
            for (const selector of articleSelectors) {
                const element = doc.querySelector(selector);
                if (element) {
                    articleText = element.textContent;
                    break;
                }
            }

            if (!articleText) {
                articleText = doc.body ? doc.body.textContent : html.replace(/<[^>]*>/g, ' ');
            }

            // Parse for individual cases
            const paragraphs = articleText.split(/\n\s*\n|\.\s+/).filter(p => p.trim().length > 20);

            paragraphs.forEach((paragraph, index) => {
                for (const namePattern of patterns.names) {
                    let match;
                    while ((match = namePattern.exec(paragraph)) !== null) {
                        const name = match[1]?.trim();
                        const age = match[2] ? parseInt(match[2]) : null;

                        if (name && name.length > 2 && age && age > 0 && age < 120) {
                            const caseData = {
                                id: generateId('CASE'),
                                name: cleanName(name),
                                arabicName: '',
                                age: age,
                                sex: determineSexFromName(name, paragraph),
                                location: extractLocationFromText(paragraph) || 'Gaza',
                                status: determineStatusFromText(paragraph),
                                circumstances: extractCircumstancesFromText(paragraph) || paragraph.substring(0, 200) + '...',
                                date_documented: currentDateTime.split(' ')[0],
                                reference_id: generateReferenceId(),
                                verification_level: 'Media Documented',
                                category: determineCategoryFromAge(age),
                                source_url: url,
                                extracted_by: currentUser,
                                extracted_at: currentDateTime
                            };

                            if (!cases.find(c => c.name === caseData.name && c.age === caseData.age)) {
                                cases.push(caseData);
                            }
                        }
                    }
                }
            });

            extractedData.cases = cases;
            displayCases(cases);
            logMessage(`üë• Found ${cases.length} individual cases`);
        }

        async function extractTextFromHTML(html) {
            logMessage('üìù Extracting text content...');

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Remove script and style elements
            const unwantedElements = doc.querySelectorAll('script, style, nav, header, footer, aside, .sidebar, .menu');
            unwantedElements.forEach(el => el.remove());

            // Extract main content
            const contentSelectors = [
                '.article-content', '.story-body', '.entry-content', '.post-content',
                'article', '.content', 'main', '[role="main"]'
            ];

            let mainContent = '';
            for (const selector of contentSelectors) {
                const element = doc.querySelector(selector);
                if (element) {
                    mainContent = element.textContent.trim();
                    break;
                }
            }

            if (!mainContent) {
                mainContent = doc.body ? doc.body.textContent.trim() : 'No content extracted';
            }

            extractedData.text = mainContent;
            displayText(mainContent);
            logMessage('üìù Text content extracted');
        }

        async function extractMetadataFromHTML(html, url) {
            logMessage('üìä Extracting metadata...');

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const metadata = {
                url: url,
                title: doc.querySelector('title')?.textContent || '',
                description: doc.querySelector('meta[name="description"]')?.getAttribute('content') || '',
                author: doc.querySelector('meta[name="author"]')?.getAttribute('content') || '',
                publishDate: doc.querySelector('meta[property="article:published_time"]')?.getAttribute('content') || '',
                keywords: doc.querySelector('meta[name="keywords"]')?.getAttribute('content') || '',
                site_name: doc.querySelector('meta[property="og:site_name"]')?.getAttribute('content') || '',
                og_title: doc.querySelector('meta[property="og:title"]')?.getAttribute('content') || '',
                og_description: doc.querySelector('meta[property="og:description"]')?.getAttribute('content') || '',
                og_image: doc.querySelector('meta[property="og:image"]')?.getAttribute('content') || '',
                extraction_date: currentDateTime,
                extracted_by: currentUser
            };

            extractedData.metadata = metadata;
            displayMetadata(metadata);
            logMessage('üìä Metadata extracted');
        }

        // Display functions
        function displayImages(images) {
            const gallery = document.getElementById('imageGallery');

            if (images.length === 0) {
                gallery.innerHTML = '<p>No relevant images found in the article.</p>';
                return;
            }

            const galleryHtml = images.map((img, index) => `
                <div class="image-item">
                    <img src="${img.src}" alt="${img.alt}" loading="lazy"
                         onerror="this.parentElement.innerHTML='<div style=\\'padding:1rem;text-align:center;color:#666;\\'>Image failed to load</div>'">
                    <div class="image-info">
                        <h5>${img.alt || 'Untitled Image'}</h5>
                        <p><strong>Caption:</strong> ${img.caption || 'No caption'}</p>
                        <p><strong>Relevance:</strong> ${img.relevance_score}</p>
                        <p><strong>Source:</strong> ${img.data_source}</p>
                        <button class="download-btn" onclick="downloadImage('${img.src}', 'image_${index}')">
                            üíæ Download
                        </button>
                    </div>
                </div>
            `).join('');

            gallery.innerHTML = galleryHtml;
        }

        function displayCases(cases) {
            const casesContainer = document.getElementById('casesData');

            if (cases.length === 0) {
                casesContainer.innerHTML = '<p>No individual cases found. Try the manual parsing method for better results.</p>';
                return;
            }

            const tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>Circumstances</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cases.map(caseItem => `
                            <tr>
                                <td>${caseItem.name}</td>
                                <td>${caseItem.age}</td>
                                <td>${caseItem.status}</td>
                                <td>${caseItem.location}</td>
                                <td>${caseItem.circumstances.substring(0, 100)}...</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            casesContainer.innerHTML = tableHtml;
        }

        function displayText(text) {
            const textContainer = document.getElementById('textContent');
            const preview = text.substring(0, 2000) + (text.length > 2000 ? '...' : '');

            textContainer.innerHTML = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: Arial, sans-serif; line-height: 1.6;">
                    <p><strong>Content Length:</strong> ${text.length} characters</p>
                    <p><strong>Preview:</strong></p>
                    <div style="max-height: 300px; overflow-y: auto; background: white; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                        ${preview.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
        }

        function displayMetadata(metadata) {
            const metadataContainer = document.getElementById('metadataContent');

            const metadataHtml = `
                <table class="data-table">
                    ${Object.entries(metadata).map(([key, value]) => `
                        <tr>
                            <th>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>
                            <td>${value || 'N/A'}</td>
                        </tr>
                    `).join('')}
                </table>
            `;

            metadataContainer.innerHTML = metadataHtml;
        }

        // Other extraction methods (simplified for space)
        async function extractUsingProxies(url) {
            logMessage('üåê Using proxy-only method...');
            await extractUsingHybridMethod(url); // Reuse hybrid logic
        }

        async function extractUsingExtension(url) {
            logMessage('üîå Attempting direct fetch (requires CORS extension)...');

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                    }
                });

                if (response.ok) {
                    const html = await response.text();
                    await extractImagesFromHTML(html, url);
                    await extractCasesFromHTML(html, url);
                    await extractTextFromHTML(html);
                    await extractMetadataFromHTML(html, url);
                    logMessage('‚úÖ Direct fetch successful');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logMessage('‚ùå Direct fetch failed - make sure CORS extension is installed and enabled');
                showExtensionInstructions();
            }
        }

        async function extractUsingAPI(url) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            logMessage('ü§ñ Using external API service...');
            // Implementation would depend on which API service is selected
            alert('API extraction not fully implemented in this demo. Please use the hybrid method.');
        }

        // Utility functions
        function updateProxyStatus(proxyName = null, status = null) {
            const statusContainer = document.getElementById('proxyStatus');

            if (!proxyName) {
                // Initialize all proxies
                const statusHtml = advancedProxyServices.map(proxy => `
                    <div class="proxy-item" id="proxy-${proxy.name.replace(/\s+/g, '-').toLowerCase()}">
                        <h5>${proxy.name}</h5>
                        <div>Status: <span class="status">Ready</span></div>
                        <div>Reliability: ${(proxy.reliability * 100).toFixed(0)}%</div>
                        <div>Images: ${proxy.supportsImages ? '‚úÖ' : '‚ùå'}</div>
                    </div>
                `).join('');
                statusContainer.innerHTML = statusHtml;
            } else {
                // Update specific proxy status
                const proxyElement = document.getElementById(`proxy-${proxyName.replace(/\s+/g, '-').toLowerCase()}`);
                if (proxyElement) {
                    proxyElement.className = `proxy-item ${status}`;
                    const statusSpan = proxyElement.querySelector('.status');
                    if (statusSpan) {
                        statusSpan.textContent = status === 'testing' ? 'Testing...' :
                                                status === 'success' ? 'Success' : 'Failed';
                    }
                }
            }
        }

        function switchResultsTab(tabName) {
            // Update tabs
            document.querySelectorAll('.results-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update content
            document.querySelectorAll('.results-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        function showManualFallback(url) {
            alert(`üîß Automatic extraction failed for:\n${url}\n\nPlease try:\n1. Installing a CORS browser extension\n2. Using the manual copy-paste method\n3. Trying a different URL format`);
        }

        function showExtensionInstructions() {
            alert(`üîå CORS Extension Required\n\nTo use direct extraction, install one of these extensions:\n\n‚Ä¢ Chrome: "CORS Unblock" or "Access-Control-Allow-Origin"\n‚Ä¢ Firefox: "CORS Everywhere" or "Disable CORS"\n\nThen reload this page and try again.`);
        }

        async function testAllProxies() {
            const url = document.getElementById('targetUrl').value;
            if (!url) {
                alert('Please enter a URL first');
                return;
            }

            logMessage('üß™ Testing all proxy services...');

            for (const proxy of advancedProxyServices) {
                try {
                    updateProxyStatus(proxy.name, 'testing');
                    const response = await fetch(proxy.url(url), { method: 'HEAD' });
                    updateProxyStatus(proxy.name, response.ok ? 'success' : 'failed');
                } catch (error) {
                    updateProxyStatus(proxy.name, 'failed');
                }
            }

            logMessage('üß™ Proxy testing completed');
        }

        async function generateAllCSVs() {
            const csvFiles = [];

            if (extractedData.images.length > 0) {
                const imagesCsv = Papa.unparse(extractedData.images);
                csvFiles.push({ name: 'extracted_images.csv', content: imagesCsv });
            }

            if (extractedData.cases.length > 0) {
                const casesCsv = Papa.unparse(extractedData.cases);
                csvFiles.push({ name: 'extracted_cases.csv', content: casesCsv });
            }

            if (extractedData.metadata && Object.keys(extractedData.metadata).length > 0) {
                const metadataCsv = Papa.unparse([extractedData.metadata]);
                csvFiles.push({ name: 'extracted_metadata.csv', content: metadataCsv });
            }

            if (csvFiles.length === 0) {
                alert('No data to export. Please extract some content first.');
                return;
            }

            // Download all CSV files
            csvFiles.forEach(file => {
                downloadCSV(file.content, file.name);
            });

            logMessage(`üìÑ Generated ${csvFiles.length} CSV files`);
        }

        function downloadImage(imageUrl, filename) {
            // Create a link to download the image
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = filename + '.jpg';
            link.target = '_blank';
            link.click();
        }

        function clearAllResults() {
            extractedData = { images: [], cases: [], text: '', metadata: {} };

            document.getElementById('imageGallery').innerHTML = '<p>No images extracted yet.</p>';
            document.getElementById('casesData').innerHTML = '<p>No cases extracted yet.</p>';
            document.getElementById('textContent').innerHTML = '<p>No text extracted yet.</p>';
            document.getElementById('metadataContent').innerHTML = '<p>No metadata extracted yet.</p>';

            logMessage('üóëÔ∏è All results cleared');
        }

        // Helper functions (reuse from previous versions)
        function generateId(prefix) {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 8);
            return `${prefix}-${timestamp}-${random}`.toUpperCase();
        }

        function generateReferenceId() {
            const date = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const random = Math.random().toString(36).substring(2, 6);
            return `REF-${date}-${random}`.toUpperCase();
        }

        function cleanName(name) {
            return name
                .replace(/^(Mr\.?|Mrs\.?|Ms\.?|Dr\.?)\s+/i, '')
                .replace(/,?\s*aged?\s*\d+.*$/i, '')
                .replace(/,?\s*\d+\s*years?\s*old.*$/i, '')
                .trim();
        }

        function determineSexFromName(name, context) {
            const lowerName = name.toLowerCase();
            const lowerContext = context.toLowerCase();

            const maleNames = ['mohammed', 'ahmad', 'omar', 'hassan', 'ali', 'youssef', 'khalil', 'ibrahim', 'adam', 'saeed'];
            const femaleNames = ['fatima', 'aisha', 'zahra', 'mariam', 'sarah', 'nour', 'rana', 'layla', 'dina', 'reem'];

            for (const maleName of maleNames) {
                if (lowerName.includes(maleName)) return 'm';
            }

            for (const femaleName of femaleNames) {
                if (lowerName.includes(femaleName)) return 'f';
            }

            if (lowerContext.includes('his ') || lowerContext.includes(' boy ') || lowerContext.includes(' son ')) {
                return 'm';
            }

            if (lowerContext.includes('her ') || lowerContext.includes(' girl ') || lowerContext.includes(' daughter ')) {
                return 'f';
            }

            return '';
        }

        function extractLocationFromText(text) {
            const locationPattern = /(?:in|from|at)\s+(Gaza(?:\s+City)?|Rafah|Khan\s+Younis|Jabalia|Deir\s+al-Balah|North\s+Gaza)/gi;
            const match = locationPattern.exec(text);
            return match ? match[1] : null;
        }

        function extractCircumstancesFromText(text) {
            const patterns = [
                /killed\s+(?:in|by|during)\s+([^.]+)/i,
                /died\s+(?:in|from|after)\s+([^.]+)/i,
                /wounded\s+(?:in|by|during)\s+([^.]+)/i
            ];

            for (const pattern of patterns) {
                const match = pattern.exec(text);
                if (match) return match[0];
            }
            return null;
        }

        function determineStatusFromText(text) {
            const lowerText = text.toLowerCase();

            if (lowerText.includes('killed') || lowerText.includes('died')) return 'Deceased';
            if (lowerText.includes('injured') || lowerText.includes('wounded')) return 'Injured';
            if (lowerText.includes('critical')) return 'Critical';
            return 'Unknown';
        }

        function determineCategoryFromAge(age) {
            if (age < 18) return 'children';
            if (age >= 60) return 'elderly';
            if (age >= 18 && age <= 35) return 'young_adult';
            return 'adult';
        }

        function downloadCSV(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function logMessage(message) {
            const logElement = document.getElementById('extractionLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;

            if (logElement) {
                logElement.textContent += logEntry;
                logElement.scrollTop = logElement.scrollHeight;
            }

            console.log(`[EXTRACTION] ${message}`);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('gaza-docs-theme', newTheme);

            const toggle = document.querySelector('.theme-toggle');
            toggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('gaza-docs-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        console.log('‚úÖ Advanced Data Extraction Tool initialized successfully');
    </script>
</body>
</html>