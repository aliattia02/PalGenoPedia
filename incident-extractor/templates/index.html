<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaza Incident Extractor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="header-nav">
        <a href="http://localhost:8000">‚Üê Back to Main Site</a>
        <a href="{{ url_for('history') }}" class="history-link">View Extraction History</a>
    </div>

    <h1>üîç Gaza Incident Extractor</h1>
    <p>Extract potential incidents from text or URLs for documentation in the Gaza Crisis platform.</p>

    <div class="tabs">
        <button class="tab-btn active" data-tab="text">Extract from Text</button>
        <button class="tab-btn" data-tab="url">Extract from URL</button>
        <button class="tab-btn" data-tab="batch">Batch URL Processing</button>
    </div>

    <div class="container">
        <div class="tab-content active" id="text-tab">
            <h2>Extract from Text</h2>
            <textarea id="incidentText" rows="8" placeholder="Paste article text here..."></textarea>
            <div class="button-group">
                <button onclick="extractFromText()" class="primary-btn">Extract Incidents</button>
                <button onclick="clearText()" class="secondary-btn">Clear</button>
            </div>
        </div>

        <div class="tab-content" id="url-tab">
            <h2>Extract from URL</h2>
            <input type="url" id="incidentUrl" placeholder="https://example.com/news-article">
            <div class="button-group">
                <button onclick="extractFromUrl()" class="primary-btn">Extract Incidents</button>
                <button onclick="clearUrl()" class="secondary-btn">Clear</button>
            </div>
        </div>

        <div class="tab-content" id="batch-tab">
            <h2>Batch URL Processing</h2>
            <p class="hint">Enter one URL per line to process multiple sources at once</p>
            <textarea id="batchUrls" rows="8" placeholder="https://example.com/article1&#10;https://example.com/article2&#10;https://example.com/article3"></textarea>
            <div class="button-group">
                <button onclick="processBatchUrls()" class="primary-btn">Process All URLs</button>
                <button onclick="clearBatchUrls()" class="secondary-btn">Clear</button>
            </div>
        </div>

        <div class="results" id="results">
            <div class="results-header">
                <h2>Extracted Incidents</h2>
                <div class="results-controls">
                    <button onclick="copyToClipboard()" class="tool-btn" title="Copy to clipboard">
                        <span class="icon">üìã</span>
                    </button>
                    <button onclick="downloadResults()" class="tool-btn" title="Download as JSON">
                        <span class="icon">üíæ</span>
                    </button>
                </div>
            </div>
            <div id="resultsContent">
                <p>Submit text or URL above to extract incidents.</p>
            </div>
        </div>
    </div>

    <!-- Status indicator -->
    <div id="statusIndicator" class="status-indicator hidden">
        <div class="spinner"></div>
        <span id="statusText">Processing...</span>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                // Add active class to clicked tab and corresponding content
                button.classList.add('active');
                document.getElementById(`${button.dataset.tab}-tab`).classList.add('active');
            });
        });

        // Show status indicator
        function showStatus(message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            statusText.textContent = message;
            indicator.classList.remove('hidden');
        }

        // Hide status indicator
        function hideStatus() {
            document.getElementById('statusIndicator').classList.add('hidden');
        }

        // Extract from text
        function extractFromText() {
            const text = document.getElementById('incidentText').value;
            if (!text) {
                alert('Please enter some text to analyze');
                return;
            }

            showStatus('Analyzing text...');

            fetch('/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text }),
            })
            .then(response => response.json())
            .then(data => {
                hideStatus();
                displayResults(data.incidents);
            })
            .catch(error => {
                hideStatus();
                console.error('Error:', error);
                document.getElementById('resultsContent').innerHTML =
                    `<div class="error-message">Error analyzing text: ${error.message}</div>`;
            });
        }

        // Extract from URL
        function extractFromUrl() {
            const url = document.getElementById('incidentUrl').value;
            if (!url) {
                alert('Please enter a URL to analyze');
                return;
            }

            showStatus('Fetching and analyzing URL...');

            fetch('/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url }),
            })
            .then(response => response.json())
            .then(data => {
                hideStatus();
                displayResults(data.incidents);
            })
            .catch(error => {
                hideStatus();
                console.error('Error:', error);
                document.getElementById('resultsContent').innerHTML =
                    `<div class="error-message">Error analyzing URL: ${error.message}</div>`;
            });
        }

        // Process batch URLs
        function processBatchUrls() {
            const urlsText = document.getElementById('batchUrls').value;
            if (!urlsText) {
                alert('Please enter URLs to analyze');
                return;
            }

            // Split by newline and filter empty lines
            const urls = urlsText.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            if (urls.length === 0) {
                alert('No valid URLs found');
                return;
            }

            showStatus(`Processing ${urls.length} URLs...`);

            fetch('/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ urls: urls }),
            })
            .then(response => response.json())
            .then(data => {
                hideStatus();
                displayBatchResults(data);
            })
            .catch(error => {
                hideStatus();
                console.error('Error:', error);
                document.getElementById('resultsContent').innerHTML =
                    `<div class="error-message">Error processing URLs: ${error.message}</div>`;
            });
        }

        // Clear inputs
        function clearText() {
            document.getElementById('incidentText').value = '';
        }

        function clearUrl() {
            document.getElementById('incidentUrl').value = '';
        }

        function clearBatchUrls() {
            document.getElementById('batchUrls').value = '';
        }

        // Display results for single extraction
        function displayResults(incidents) {
            const resultsDiv = document.getElementById('resultsContent');

            if (!incidents || incidents.length === 0) {
                resultsDiv.innerHTML = '<p>No incidents detected in the provided content.</p>';
                return;
            }

            // Store the results for copy/download functionality
            window.extractedResults = incidents;

            let html = '';
            incidents.forEach((incident, index) => {
                html += `
                    <div class="incident">
                        <h3>Incident #${index + 1}</h3>
                        <div class="incident-type ${incident.type || 'general'}">${incident.type || 'Unknown'}</div>
                        <p class="incident-description">${incident.description}</p>

                        <div class="incident-details">
                            <div class="detail">
                                <span class="detail-label">Location:</span>
                                <span class="detail-value">${incident.location || 'Unknown'}</span>
                            </div>
                            <div class="detail">
                                <span class="detail-label">Date:</span>
                                <span class="detail-value">${incident.date || 'Unknown'}</span>
                            </div>
                            ${incident.casualties ?
                                `<div class="detail casualties">
                                    <span class="detail-label">Casualties:</span>
                                    <span class="detail-value">
                                        ${incident.casualties.deaths ? `<span class="deaths">${incident.casualties.deaths} killed</span>` : ''}
                                        ${incident.casualties.injured ? `<span class="injured">${incident.casualties.injured} injured</span>` : ''}
                                    </span>
                                </div>` : ''}
                            ${incident.source ?
                                `<div class="detail">
                                    <span class="detail-label">Source:</span>
                                    <span class="detail-value">${incident.source}</span>
                                </div>` : ''}
                            ${incident.article_title ?
                                `<div class="detail">
                                    <span class="detail-label">Article:</span>
                                    <span class="detail-value">${incident.article_title}</span>
                                </div>` : ''}
                        </div>

                        ${incident.images && incident.images.length > 0 ?
                            `<div class="incident-images">
                                <h4>Related Images</h4>
                                <div class="image-gallery">
                                    ${incident.images.slice(0, 3).map(img =>
                                        `<div class="image-item">
                                            <img src="${img.url}" alt="${img.alt_text || 'Incident image'}"
                                                onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/image-placeholder.png') }}'"
                                            />
                                            <div class="image-caption">${img.alt_text || 'No caption available'}</div>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>` : ''}
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Display results for batch processing
        function displayBatchResults(data) {
            const resultsDiv = document.getElementById('resultsContent');

            // Store the results for copy/download functionality
            window.extractedResults = data;

            let html = `
                <div class="batch-summary">
                    <h3>Batch Processing Summary</h3>
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-value">${data.stats.total_urls}</span>
                            <span class="stat-label">URLs Processed</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${data.stats.successful_urls}</span>
                            <span class="stat-label">Successful</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${data.stats.failed_urls}</span>
                            <span class="stat-label">Failed</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${data.stats.total_incidents}</span>
                            <span class="stat-label">Incidents Found</span>
                        </div>
                    </div>
                </div>
            `;

            // Show errors if any
            if (data.errors && data.errors.length > 0) {
                html += `
                    <div class="errors-section">
                        <h4>Processing Errors</h4>
                        <ul class="error-list">
                            ${data.errors.map(error =>
                                `<li><span class="error-url">${error.url}</span>: ${error.error}</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }

            // Show extracted incidents
            if (data.incidents && data.incidents.length > 0) {
                html += `<h3>Extracted Incidents (${data.incidents.length})</h3>`;

                data.incidents.forEach((incident, index) => {
                    html += `
                        <div class="incident">
                            <h4>Incident #${index + 1}</h4>
                            <div class="incident-type ${incident.type || 'general'}">${incident.type || 'Unknown'}</div>
                            <p class="incident-description">${incident.description}</p>

                            <div class="incident-details">
                                <div class="detail">
                                    <span class="detail-label">Location:</span>
                                    <span class="detail-value">${incident.location || 'Unknown'}</span>
                                </div>
                                <div class="detail">
                                    <span class="detail-label">Date:</span>
                                    <span class="detail-value">${incident.date || 'Unknown'}</span>
                                </div>
                                ${incident.casualties ?
                                    `<div class="detail casualties">
                                        <span class="detail-label">Casualties:</span>
                                        <span class="detail-value">
                                            ${incident.casualties.deaths ? `<span class="deaths">${incident.casualties.deaths} killed</span>` : ''}
                                            ${incident.casualties.injured ? `<span class="injured">${incident.casualties.injured} injured</span>` : ''}
                                        </span>
                                    </div>` : ''}
                                <div class="detail">
                                    <span class="detail-label">Source:</span>
                                    <span class="detail-value">
                                        <a href="${incident.article_url}" target="_blank">
                                            ${incident.source}
                                        </a>
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<p>No incidents were extracted from the provided URLs.</p>`;
            }

            resultsDiv.innerHTML = html;
        }

        // Copy results to clipboard
        function copyToClipboard() {
            if (!window.extractedResults) {
                alert('No results to copy');
                return;
            }

            const text = JSON.stringify(window.extractedResults, null, 2);
            navigator.clipboard.writeText(text)
                .then(() => {
                    alert('Results copied to clipboard');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy results');
                });
        }

        // Download results as JSON file
        function downloadResults() {
            if (!window.extractedResults) {
                alert('No results to download');
                return;
            }

            const dataStr = JSON.stringify(window.extractedResults, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportName = `incident-extraction-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }
    </script>
</body>
</html>